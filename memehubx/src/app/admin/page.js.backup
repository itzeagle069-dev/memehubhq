"use client";

import { useEffect, useState } from "react";
import { useAuth } from "@/context/AuthContext";
import { db } from "@/lib/firebase";
import { collection, query, where, getDocs, updateDoc, doc, deleteDoc } from "firebase/firestore";
import { Check, Trash2, ShieldAlert, Loader2, Edit2, X, Image as ImageIcon } from "lucide-react";
import { toast } from "react-hot-toast";
import { useRouter } from "next/navigation";

// ðŸ”´ PASTE YOUR COPIED UID HERE
const ADMIN_IDS = ["VZCDwbnsLxcLdEcjabk8wK0pEv33"];
const CLOUD_NAME = "ds6pks59z";
const UPLOAD_PRESET = "memehub_upload";

export default function AdminPage() {
    // Security Check: Kick them out if not Admin
    if (!user || !ADMIN_IDS.includes(user.uid)) {
        router.push("/");
        return;
    }

    const fetchPending = async () => {
        try {
            const q = query(collection(db, "memes"), where("status", "==", "pending"));
            const snapshot = await getDocs(q);
            const memes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setPendingMemes(memes);
        } catch (err) {
            toast.error("Failed to load memes");
        } finally {
            setFetching(false);
        }
    };

    fetchPending();
}, [user, loading, router]);

// 2. Approve Function
const approveMeme = async (memeId) => {
    try {
        await updateDoc(doc(db, "memes", memeId), {
            status: "published",
            publishedAt: new Date().toISOString()
        });
        // Remove from local list so it disappears from screen
        setPendingMemes(prev => prev.filter(m => m.id !== memeId));
        toast.success("Meme Published!");
    } catch (err) {
        toast.error("Error approving");
    }
};

// 3. Reject/Delete Function
const deleteMeme = async (memeId) => {
    if (!confirm("Delete this permanently?")) return;

    try {
        await deleteDoc(doc(db, "memes", memeId));
        setPendingMemes(prev => prev.filter(m => m.id !== memeId));
        toast.error("Meme Deleted");
    } catch (err) {
        toast.error("Error deleting");
    }
};

// 4. Open Edit Modal
const openEditModal = (meme) => {
    setEditingMeme(meme);
    setEditForm({
        title: meme.title,
        category: meme.category,
        language: meme.language,
        thumbnail_url: meme.thumbnail_url || ""
    });
    setNewThumbnail(null);
    setThumbnailPreview(null);
};

// 5. Handle Thumbnail Upload for Edit
const handleThumbnailChange = (e) => {
    const selected = e.target.files[0];
    if (!selected) return;
    if (!selected.type.startsWith("image/")) {
        toast.error("Thumbnail must be an image file");
        return;
    }
    setNewThumbnail(selected);
    setThumbnailPreview(URL.createObjectURL(selected));
};

// 6. Save Edits
const saveEdits = async () => {
    if (!editForm.title.trim()) {
        toast.error("Title cannot be empty");
        return;
    }

    setSaving(true);
    const toastId = toast.loading("Saving changes...");

    try {
        let thumbnailUrl = editForm.thumbnail_url;

        // Upload new thumbnail if provided
        if (newThumbnail) {
            toast.loading("Uploading new thumbnail...", { id: toastId });

            const thumbFormData = new FormData();
            thumbFormData.append("file", newThumbnail);
            thumbFormData.append("upload_preset", UPLOAD_PRESET);

            const thumbRes = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                method: "POST",
                body: thumbFormData,
            });

            const thumbData = await thumbRes.json();
            if (thumbData.secure_url) {
                thumbnailUrl = thumbData.secure_url;
            }
        }

        // Update Firestore
        await updateDoc(doc(db, "memes", editingMeme.id), {
            title: editForm.title,
            category: editForm.category,
            language: editForm.language,
            thumbnail_url: thumbnailUrl,
            tags: editForm.title.toLowerCase().split(" ")
        });

        // Update local state
        setPendingMemes(prev => prev.map(m =>
            m.id === editingMeme.id
                ? { ...m, ...editForm, thumbnail_url: thumbnailUrl }
                : m
        ));

        toast.success("Changes saved!", { id: toastId });
        setEditingMeme(null);
    } catch (error) {
        console.error("Error saving edits:", error);
        toast.error("Failed to save changes", { id: toastId });
    } finally {
        setSaving(false);
    }
};

if (loading || fetching) {
    return <div className="flex h-screen items-center justify-center"><Loader2 className="animate-spin text-yellow-400 w-10 h-10" /></div>;
}

return (
    <div className="max-w-6xl mx-auto py-10 px-4">
        <div className="flex items-center gap-3 mb-8">
            <ShieldAlert className="w-10 h-10 text-red-500" />
            <h1 className="text-3xl font-black">Admin <span className="text-yellow-400">Dashboard</span></h1>
            <span className="ml-auto bg-yellow-400/20 text-yellow-600 px-4 py-1 rounded-full text-sm font-bold">
                {pendingMemes.length} Pending
            </span>
        </div>

        {pendingMemes.length === 0 ? (
            <div className="text-center py-20 bg-gray-50 dark:bg-[#111] rounded-3xl border border-gray-100 dark:border-[#222]">
                <h2 className="text-2xl font-bold text-gray-400">All caught up! ðŸŽ‰</h2>
                <p className="text-gray-500">No memes waiting for review.</p>
            </div>
        ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {pendingMemes.map((meme) => (
                    <div key={meme.id} className="bg-white dark:bg-[#1a1a1a] rounded-xl overflow-hidden border border-gray-200 dark:border-gray-800 shadow-xl">

                        {/* MEDIA PREVIEW */}
                        <div className="aspect-video bg-gradient-to-br from-gray-900 to-black flex items-center justify-center relative">
                            {/* Show thumbnail if available, otherwise show actual media */}
                            {meme.thumbnail_url ? (
                                <img
                                    src={meme.thumbnail_url}
                                    alt={meme.title}
                                    className="max-h-full max-w-full object-contain"
                                />
                            ) : meme.media_type === "image" ? (
                                <img
                                    src={meme.file_url}
                                    alt={meme.title}
                                    className="max-h-full max-w-full object-contain"
                                />
                            ) : meme.media_type === "video" ? (
                                <video
                                    src={meme.file_url}
                                    controls
                                    className="w-full h-full object-contain"
                                    preload="metadata"
                                />
                            ) : (meme.media_type === "raw" || meme.media_type === "audio") ? (
                                <div className="flex flex-col items-center justify-center gap-4 p-6">
                                    <div className="bg-yellow-400/20 p-6 rounded-full">
                                        <svg className="w-16 h-16 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" />
                                        </svg>
                                    </div>
                                    <p className="text-white font-bold text-lg">Audio File ðŸŽµ</p>
                                    <audio
                                        src={meme.file_url}
                                        controls
                                        className="w-full max-w-xs"
                                        preload="metadata"
                                    />
                                </div>
                            ) : null}

                            {/* Media Type Badge */}
                            <div className="absolute top-2 right-2 bg-yellow-400 text-black text-xs px-3 py-1 rounded-full font-bold uppercase">
                                {meme.media_type === "raw" ? "audio" : meme.media_type}
                            </div>

                            {/* Language & Category Badge */}
                            <div className="absolute top-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded">
                                {meme.language} | {meme.category}
                            </div>
                        </div>

                        {/* CONTROLS */}
                        <div className="p-4 space-y-4">
                            <div>
                                <h3 className="font-bold text-lg truncate">{meme.title}</h3>
                                <p className="text-xs text-gray-500">by {meme.uploader_name}</p>
                            </div>

                            <div className="grid grid-cols-3 gap-2">
                                <button
                                    onClick={() => deleteMeme(meme.id)}
                                    className="flex items-center justify-center gap-1 bg-red-100 text-red-600 hover:bg-red-200 py-2 rounded-lg font-bold transition-colors text-sm"
                                >
                                    <Trash2 className="w-4 h-4" /> Reject
                                </button>
                                <button
                                    onClick={() => openEditModal(meme)}
                                    className="flex items-center justify-center gap-1 bg-blue-100 text-blue-600 hover:bg-blue-200 py-2 rounded-lg font-bold transition-colors text-sm"
                                >
                                    <Edit2 className="w-4 h-4" /> Edit
                                </button>
                                <button
                                    onClick={() => approveMeme(meme.id)}
                                    className="flex items-center justify-center gap-1 bg-green-100 text-green-700 hover:bg-green-200 py-2 rounded-lg font-bold transition-colors text-sm"
                                >
                                    <Check className="w-4 h-4" /> Approve
                                </button>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        )}

        {/* EDIT MODAL */}
        {editingMeme && (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={() => setEditingMeme(null)}>
                <div className="relative w-full max-w-2xl bg-white dark:bg-[#1a1a1a] rounded-2xl overflow-hidden shadow-2xl border border-gray-200 dark:border-gray-800" onClick={e => e.stopPropagation()}>

                    {/* Close Button */}
                    <button
                        onClick={() => setEditingMeme(null)}
                        className="absolute top-4 right-4 z-10 p-2 rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
                    >
                        <X size={20} />
                    </button>

                    <div className="p-8">
                        <h2 className="text-2xl font-black mb-6">Edit Meme</h2>

                        <div className="space-y-4">
                            {/* Title */}
                            <div>
                                <label className="block text-sm font-bold mb-2">Title</label>
                                <input
                                    type="text"
                                    value={editForm.title}
                                    onChange={(e) => setEditForm({ ...editForm, title: e.target.value })}
                                    className="w-full p-3 rounded-lg bg-gray-100 dark:bg-[#2a2a2a] dark:text-white outline-none focus:ring-2 focus:ring-yellow-400 transition-all"
                                />
                            </div>

                            {/* Category & Language */}
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-bold mb-2">Category</label>
                                    <select
                                        value={editForm.category}
                                        onChange={(e) => setEditForm({ ...editForm, category: e.target.value })}
                                        className="w-full p-3 rounded-lg bg-gray-100 dark:bg-[#2a2a2a] dark:text-white outline-none focus:ring-2 focus:ring-yellow-400 transition-all cursor-pointer"
                                    >
                                        <option value="reaction">Funny Reaction</option>
                                        <option value="trending">Trending</option>
                                        <option value="animal">Animals</option>
                                        <option value="work">Work/Office</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-bold mb-2">Language</label>
                                    <select
                                        value={editForm.language}
                                        onChange={(e) => setEditForm({ ...editForm, language: e.target.value })}
                                        className="w-full p-3 rounded-lg bg-gray-100 dark:bg-[#2a2a2a] dark:text-white outline-none focus:ring-2 focus:ring-yellow-400 transition-all cursor-pointer"
                                    >
                                        <option value="english">English</option>
                                        <option value="nepali">Nepali</option>
                                        <option value="hindi">Hindi</option>
                                    </select>
                                </div>
                            </div>

                            {/* Thumbnail Upload */}
                            {(editingMeme.media_type === "video" || editingMeme.media_type === "raw" || editingMeme.media_type === "audio") && (
                                <div>
                                    <label className="block text-sm font-bold mb-2">Custom Thumbnail</label>
                                    <div className="border-2 border-dashed border-blue-300 dark:border-blue-700 rounded-xl p-6 text-center hover:bg-blue-50 dark:hover:bg-blue-900/10 relative transition-colors">
                                        <input
                                            type="file"
                                            accept="image/*"
                                            onChange={handleThumbnailChange}
                                            className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                        />

                                        {thumbnailPreview ? (
                                            <div className="flex flex-col items-center">
                                                <img src={thumbnailPreview} className="h-32 rounded-lg object-contain mb-2" />
                                                <p className="text-sm text-blue-500 font-bold">New thumbnail ready</p>
                                            </div>
                                        ) : editForm.thumbnail_url ? (
                                            <div className="flex flex-col items-center">
                                                <img src={editForm.thumbnail_url} className="h-32 rounded-lg object-contain mb-2" />
                                                <p className="text-xs text-gray-500">Click to change thumbnail</p>
                                            </div>
                                        ) : (
                                            <div className="flex flex-col items-center text-gray-500 dark:text-gray-400">
                                                <ImageIcon className="w-10 h-10 mb-2 text-blue-400" />
                                                <p className="font-semibold">Add Custom Thumbnail</p>
                                                <p className="text-xs mt-1">Upload an image to make your meme more engaging</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* Action Buttons */}
                            <div className="flex gap-3 pt-4">
                                <button
                                    onClick={() => setEditingMeme(null)}
                                    className="flex-1 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 text-black dark:text-white font-bold hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={saveEdits}
                                    disabled={saving}
                                    className="flex-1 py-3 rounded-xl bg-yellow-400 hover:bg-yellow-500 text-black font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {saving ? "Saving..." : "Save Changes"}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        )}
    </div>
);
}